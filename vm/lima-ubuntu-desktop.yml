# Lima configuration for Ubuntu Desktop VM (Local Development)
# https://github.com/lima-vm/lima

---
# VM details - tuned for local development
cpus: 4
memory: "4GiB"
disk: "40GiB"

# Ubuntu image
images:
  # yamllint disable-line rule:line-length
  - location: "https://cloud-images.ubuntu.com/noble/current/noble-server-cloudimg-amd64.img"
    arch: "x86_64"

# SSH configuration
ssh:
  # Do NOT load host user's ~/.ssh/*.pub automatically. This avoids warnings
  # when there are malformed or non-OpenSSH files in the host ~/.ssh directory.
  loadDotSSHPubKeys: false
  localPort: 60022

# Mount current project directory for easier development
mounts:
  - location: "."
    writable: true

# Enhanced provisioning for local development
provision:
  - mode: system
    script: |
      #!/bin/bash
      set -eux -o pipefail

      # Update package list
      apt-get update

      # Install packages needed for the install script and development  
      DEBIAN_FRONTEND=noninteractive apt-get install -y \
        curl \
        wget \
        sudo \
        systemd \
        git \
        openssh-server \
        python3 \
        python3-pip \
        dbus-x11 \
        xvfb \
        dconf-cli \
        gconf-service \
        gsettings-desktop-schemas

      # Ensure SSH is properly configured
      systemctl enable ssh
      systemctl start ssh

      # Allow SSH with password (for testing)
      sed -i 's/^#*PasswordAuthentication.*/PasswordAuthentication yes/' \
        /etc/ssh/sshd_config
      sed -i 's/^#*PubkeyAuthentication.*/PubkeyAuthentication yes/' \
        /etc/ssh/sshd_config
      systemctl reload ssh

      # Enable dbus for GUI operations
      systemctl enable dbus
      systemctl start dbus

      echo "✅ Enhanced Ubuntu VM setup with GUI support complete"

  - mode: user
    script: |
      #!/bin/bash
      set -eux -o pipefail

      # Create SSH directory and set permissions
      mkdir -p ~/.ssh
      chmod 700 ~/.ssh

      echo "✅ User environment setup complete"

# Network configuration (using Lima defaults for Linux hosts)
