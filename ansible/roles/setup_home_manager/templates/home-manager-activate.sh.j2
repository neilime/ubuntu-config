#!/usr/bin/env bash
set -euo pipefail

# Verify nix-daemon profile exists
if [ ! -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
	echo "ERROR: Nix daemon profile not found. Nix installation may be incomplete."
	exit 1
fi
# Source nix daemon profile
# shellcheck disable=SC1091
. /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
# Change to home-manager config directory
cd "{{ setup_home_manager_user_home }}/.config/home-manager"

echo "=== Starting Home Manager activation ==="

# Ensure we're working with the correct user profile paths
USER_PROFILE="/nix/var/nix/profiles/per-user/{{ ansible_user }}/profile"

# Check if there are any conflicting packages one more time (using explicit profile)
echo "Final check for conflicting nix-env packages..."
if nix-env --profile "$USER_PROFILE" -q 2>/dev/null | grep -q .; then
	echo "WARNING: Still found nix-env packages that could conflict:"
	nix-env --profile "$USER_PROFILE" -q
	echo "Attempting to remove them..."
	nix-env --profile "$USER_PROFILE" -e '*' || echo "Could not remove all packages, proceeding anyway"
fi

# Also check default profile symlink
DEFAULT_PROFILE="$HOME/.nix-profile"
if [ -L "$DEFAULT_PROFILE" ]; then
	echo "Checking default profile symlink for packages..."
	# Only check if we can actually access it without permission errors
	if nix-env --profile "$DEFAULT_PROFILE" -q 2>/dev/null | grep -q .; then
		echo "WARNING: Found packages in default profile symlink:"
		nix-env --profile "$DEFAULT_PROFILE" -q
		echo "Attempting to remove them..."
		nix-env --profile "$DEFAULT_PROFILE" -e '*' || echo "Could not remove packages from default profile, proceeding anyway"
	fi
fi

# Run home-manager switch with proper environment and better error output
echo "Running home-manager switch..."
# shellcheck disable=SC1083,SC2288
timeout 1800 /nix/var/nix/profiles/per-user/{{ ansible_user }}/profile/bin/home-manager \
	switch --flake ".#{{ ansible_user }}" \
	--extra-experimental-features 'nix-command flakes' \
	--show-trace || {
	echo "=== Home Manager switch failed ==="
	echo "Checking for remaining nix-env packages:"
	nix-env --profile "$USER_PROFILE" -q || echo "No nix-env packages found in user profile"
	if [ -L "$DEFAULT_PROFILE" ]; then
		nix-env --profile "$DEFAULT_PROFILE" -q || echo "No nix-env packages found in default profile"
	fi
	echo "Checking home-manager version:"
	# shellcheck disable=SC1083,SC2288
	/nix/var/nix/profiles/per-user/{{ ansible_user }}/profile/bin/home-manager --version || echo "Could not check home-manager version"
	echo "=== End of failure diagnostics ==="
	exit 1
}

echo "=== Home Manager activation completed successfully ==="
