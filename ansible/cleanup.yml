---
- name: Cleanup personal computer
  hosts: personal_computer
  become: true
  vars:
    ansible_config_dir: "/home/ansible/config"
  tasks:
    - name: Try to get container facts using community.docker
      community.docker.current_container_facts:
      register: container_facts
      failed_when: false
      changed_when: false
      ignore_errors: true

    - name: Set docker_test_env fact
      ansible.builtin.set_fact:
        docker_test_env: >-
          {{ (container_facts is defined and container_facts.ansible_facts is defined and
              container_facts.ansible_facts.ansible_module_running_in_container) | default(false) }}
      changed_when: false

    - name: Docker prune
      community.docker.docker_prune:
        containers: true
        images: true
        images_filters:
          dangling: false
        networks: true
        volumes: true
        builder_cache: true
      when: not docker_test_env

    - name: Clear useless apt resources using localepurge
      ansible.builtin.apt:
        name: localepurge
        state: present
      notify: Run localepurge

    - name: Update system using ucaresystem-core
      ansible.builtin.command: ucaresystem-core -u
      when: not docker_test_env

    - name: Remove APT dependencies that are no longer required and purge their configuration files
      ansible.builtin.apt:
        autoremove: yes
        purge: true

  handlers:
    - name: Run localepurge
      ansible.builtin.command: localepurge
