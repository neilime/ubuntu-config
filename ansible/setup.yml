---
- name: Setup personal computer
  hosts: personal_computer
  become: true
  vars:
    ansible_config_dir: "/home/ansible/config"

  tasks:
    # jscpd:ignore-start
    - name: Try to get container facts using community.docker
      community.docker.current_container_facts:
      register: container_facts
      failed_when: false
      changed_when: false
      ignore_errors: true

    - name: Set docker_test_env fact
      ansible.builtin.set_fact:
        docker_test_env: >-
          {{ (container_facts is defined and container_facts.ansible_facts is defined and
              container_facts.ansible_facts.ansible_module_running_in_container) | default(false) }}
      changed_when: false
    # jscpd:ignore-end

    - name: Setup system
      ansible.builtin.import_role:
        name: setup_system
      vars:
        setup_system_apt: "{{ system.apt }}"
        setup_system_locale: "{{ system.locale }}"
        setup_system_timezone: "{{ system.timezone }}"
        setup_system_favorites: "{{ system.favorites }}"
      tags: [system]

    # DESKTOP LAYER - Domain-based GUI applications and desktop environment
    - name: Setup browser
      ansible.builtin.import_role:
        name: setup_browser
      vars:
        setup_browser_flatpak: "{{ browser.flatpak }}"
        setup_browser_favorites: "{{ browser.favorites }}"
      tags: [browser, desktop]

    - name: Setup communication
      ansible.builtin.import_role:
        name: setup_communication
      vars:
        setup_communication_flatpak: "{{ communication.flatpak }}"
        setup_communication_favorites: "{{ communication.favorites }}"
      tags: [communication, desktop]

    - name: Setup development
      ansible.builtin.import_role:
        name: setup_development
      vars:
        setup_development_repositories: "{{ development.repositories }}"
        setup_development_apt: "{{ development.apt }}"
        setup_development_flatpak: "{{ development.flatpak }}"
        setup_development_projects_directory: >-
          {{ development.projects_directory }}
        setup_development_favorites: "{{ development.favorites }}"
      tags: [development, desktop]

    - name: Setup media
      ansible.builtin.import_role:
        name: setup_media
      vars:
        setup_media_flatpak: "{{ media.flatpak }}"
        setup_media_favorites: "{{ media.favorites }}"
      tags: [media, desktop]

    - name: Setup utility
      ansible.builtin.import_role:
        name: setup_utility
      vars:
        setup_utility_apt: "{{ utility.apt }}"
        setup_utility_flatpak: "{{ utility.flatpak }}"
        setup_utility_favorites: "{{ utility.favorites }}"
      tags: [utility, desktop]

    - name: Setup Home Manager for user configurations
      ansible.builtin.import_role:
        name: setup_home_manager
      vars:
        setup_home_manager_git: "{{ development.git }}"
        setup_home_manager_shell: "{{ development.shell }}"
        setup_home_manager_nix_packages: "{{ development.nix_packages }}"
        setup_home_manager_environment: "{{ development.environment }}"
      tags: [home-manager, user]
      become: false

    # USER LAYER - User-specific configurations
    - name: Setup keys
      ansible.builtin.import_role:
        name: setup_keys
      tags: [keys, user]
      vars:
        setup_keys_bitwarden_server: "{{ bitwarden.server }}"
        setup_keys_bitwarden_email: "{{ bitwarden.email }}"
        setup_keys_bitwarden_password: "{{ bitwarden.password }}"
        setup_keys_bitwarden_client_id: "{{ bitwarden.client_id }}"
        setup_keys_bitwarden_client_secret: "{{ bitwarden.client_secret }}"
        setup_keys_bitwarden_ssh_keys_collection_id: >-
          {{ bitwarden.sshKeysCollectionId }}
        setup_keys_bitwarden_gpg_keys_collection_id: >-
          {{ bitwarden.gpgKeysCollectionId }}
