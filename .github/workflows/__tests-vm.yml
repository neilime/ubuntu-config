name: Shared - Tests - VM

on:
  workflow_call:

permissions: {}

jobs:
  tests-vm:
    name: Tests - VM
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      BITWARDEN_EMAIL: ${{ secrets.BITWARDEN_EMAIL }}
      BITWARDEN_PASSWORD: ${{ secrets.BITWARDEN_PASSWORD }}
      INSTALL_SCRIPT: https://raw.githubusercontent.com/neilime/ubuntu-config/${{ github.sha }}/install.sh
      REPOSITORY_URL: ${{ github.event.repository.clone_url }}
      REPOSITORY_BRANCH: ${{ github.sha }}
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Lima
        uses: lima-vm/lima-actions/setup@03b96d61959e83b2c737e44162c3088e81de0886 # v1.0.1
        id: lima-actions-setup

      - name: Cache Lima
        uses: actions/cache@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          path: ~/.cache/lima
          key: lima-${{ steps.lima-actions-setup.outputs.version }}

      - name: Start Lima Ubuntu Desktop VM
        run: |
          limactl start --name=ubuntu-desktop vm/lima-ubuntu-desktop.yml

      - name: Set up SSH for Lima
        uses: lima-vm/lima-actions/ssh@03b96d61959e83b2c737e44162c3088e81de0886 # v1.0.1

      - name: Wait for VM to be ready
        run: |
          echo "⏳ Waiting for VM to be ready..."

          # Wait for SSH to be accessible
          for i in {1..120}; do
            if ssh lima-ubuntu-desktop echo "✅ SSH ready" 2>/dev/null; then
              echo "✅ VM is ready and SSH is up"
              break
            fi
            echo "Attempt $i/120: Waiting for VM..."
            sleep 10
          done

      - name: Run install script
        run: |
          ssh lima-ubuntu-desktop 'wget -qO- "'"$INSTALL_SCRIPT"'" | sudo bash && sudo touch /e2e.success'

      - name: Validate Ansible changes in host - Snap packages
        run: |
          ssh lima-ubuntu-desktop '[ -f /e2e.success ] && echo "✅ Success" || { echo "❌ Setup failed"; exit 1; }'
