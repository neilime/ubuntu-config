name: Shared - Tests - VM

on:
  workflow_call:

permissions: {}

jobs:
  tests-vm:
    name: Tests - VM
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      BITWARDEN_EMAIL: ${{ secrets.BITWARDEN_EMAIL }}
      BITWARDEN_PASSWORD: ${{ secrets.BITWARDEN_PASSWORD }}
      INSTALL_SCRIPT: https://raw.githubusercontent.com/neilime/ubuntu-config/${{ github.sha }}/install.sh
      REPOSITORY_URL: ${{ github.event.repository.clone_url }}
      REPOSITORY_BRANCH: ${{ github.sha }}
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Start Lima Ubuntu Desktop VM
        uses: lima-vm/lima-action@f2b3e3c9e6da5bfe607c4cf2c8a66b9064d8e3ea # v0.2.0
        with:
          config: vm/lima-ubuntu-desktop.yml
          name: ubuntu-desktop

      - name: Wait for VM to be ready
        run: |
          echo "⏳ Waiting for VM to be ready..."

          # Wait for SSH to be accessible
          for i in {1..120}; do
            if limactl shell ubuntu-desktop echo "✅ SSH ready" 2>/dev/null; then
              echo "✅ VM is ready and SSH is up"
              break
            fi
            echo "Attempt $i/120: Waiting for VM..."
            sleep 10
          done

      - name: Run install script
        run: |
          limactl shell ubuntu-desktop "wget -qO- \"$INSTALL_SCRIPT\" | sudo bash && sudo touch /e2e.success"

      - name: Validate Ansible changes in host - Snap packages
        run: |
          limactl shell ubuntu-desktop '[ -f /e2e.success ] && echo "✅ Success" || { echo "❌ Setup failed"; exit 1; }'
