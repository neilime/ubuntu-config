name: Shared - Tests - VM

on:
  workflow_call:
    inputs:
      test-image:
        description: "Test CI Docker image to use"
        required: true
        type: string

permissions: {}

jobs:
  tests-vm:
    name: Tests - VM
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      BITWARDEN_CLIENT_ID: ${{ secrets.BITWARDEN_CLIENT_ID }}
      BITWARDEN_CLIENT_SECRET: ${{ secrets.BITWARDEN_CLIENT_SECRET }}
      BITWARDEN_PASSWORD: ${{ secrets.BITWARDEN_PASSWORD }}
      INSTALL_SCRIPT: https://raw.githubusercontent.com/neilime/ubuntu-config/${{ github.head_ref || github.ref_name }}/install.sh
      REPOSITORY_URL: ${{ github.event.repository.clone_url }}
      REPOSITORY_BRANCH: ${{ github.head_ref || github.ref_name }}
      TEST_IMAGE: ${{ inputs.test-image }}
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Lima
        uses: lima-vm/lima-actions/setup@03b96d61959e83b2c737e44162c3088e81de0886 # v1.0.1
        id: lima-actions-setup

      - name: Cache Lima
        uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4.2.4
        with:
          path: ~/.cache/lima
          key: lima-${{ steps.lima-actions-setup.outputs.version }}

      - name: Start Lima Ubuntu Desktop VM
        run: |
          limactl start --name=ubuntu-desktop vm/lima-ubuntu-desktop.yml

      - name: Set up SSH for Lima
        uses: lima-vm/lima-actions/ssh@03b96d61959e83b2c737e44162c3088e81de0886 # v1.0.1
        with:
          name: ubuntu-desktop

      - name: Wait for VM to be ready
        run: |
          echo "⏳ Waiting for VM to be ready..."

          # Wait for SSH to be accessible
          for i in {1..120}; do
            if ssh lima-ubuntu-desktop echo "✅ SSH ready" 2>/dev/null; then
              echo "✅ VM is ready and SSH is up"
              break
            fi
            echo "Attempt $i/120: Waiting for VM..."
            sleep 10
          done

      - name: Run install script
        run: |
          # Create and upload a script to properly set environment variables and run the install script
          cat > /tmp/run_install.sh << 'EOF'
          #!/bin/bash
          set -eu

          # Export environment variables
          export BITWARDEN_CLIENT_ID="$1"
          export BITWARDEN_CLIENT_SECRET="$2"
          export BITWARDEN_PASSWORD="$3"
          export REPOSITORY_URL="$4"
          export REPOSITORY_BRANCH="$5"

          # Download and run the install script
          wget -qO- "$6" | sudo -E sh

          # Create success marker
          sudo touch /e2e.success
          EOF

          # Make the script executable
          chmod +x /tmp/run_install.sh

          # Copy the script to the VM
          scp /tmp/run_install.sh lima-ubuntu-desktop:/tmp/run_install.sh

          # Execute the script on the VM with proper argument passing
          # shellcheck disable=SC2029
          ssh lima-ubuntu-desktop "bash /tmp/run_install.sh \
            '$BITWARDEN_CLIENT_ID' \
            '$BITWARDEN_CLIENT_SECRET' \
            '$BITWARDEN_PASSWORD' \
            '$REPOSITORY_URL' \
            '$REPOSITORY_BRANCH' \
            '$INSTALL_SCRIPT'"

      - name: Validate setup success
        run: |
          ssh lima-ubuntu-desktop '[ -f /e2e.success ] && echo "✅ Success" || { echo "❌ Setup failed"; exit 1; }'

      - name: Run TestInfra tests on VM using test image
        run: |
          docker run --rm --network host -v "$PWD":/workspace -w /workspace \
            "$TEST_IMAGE" \
            python3 tests/run_tests.py --verbose --host="ssh://ubuntu@127.0.0.1:2222" --user="ubuntu"
